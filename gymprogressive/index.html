<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.101.0">

    <title>Жим "Прогрессивный"</title>
    
    <link href="css/template.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js" integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
    <script src="js/config.js" async defer></script>
    <script src="js/gapi.js"></script>
</head>
<body>

<header class="p-3 mb-3 border-bottom">
  <div class="container">
    <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
      <a class="navbar-brand" href="javascript:void(0)">
        <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
          <svg xmlns="http://www.w3.org/2000/svg" width="40" height="32" fill="currentColor" class="bi bi-bar-chart-fill" viewBox="0 0 16 16">
            <title>Жим "Прогрессивный"</title>
            <path d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2z"/>
          </svg>
          <span class="fs-4">Жим "Прогрессивный"</span>
        </a>
      </a>

      <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
        <li><a href="#" class="nav-link px-2 link-secondary">О сайте</a></li>
        <li><a href="#" class="nav-link px-2 link-dark">Контакты</a></li>
      </ul>

      <div class="dropdown text-end">
        <a href="#" class="d-block link-dark text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          <img id="_imgAvatar" src="https://via.placeholder.com/32/343a40/FFFFFF/?text=Ё" class="rounded-circle" width="32" height="32"></img> 
        </a>
        <ul class="dropdown-menu dropdown-menu-dark text-small">
          <li><a id="itemStart" class="dropdown-item" href="#">Начать тренировку...</a></li>
          <li><a id="itemSettings" class="dropdown-item" href="#">Настройки</a></li>
          <li><a id="itemProfile" class="dropdown-item" href="#">Профиль</a></li>
          <li><hr class="dropdown-divider"></li>
          <li id="_getToken"><a class="dropdown-item" href="#" onclick="getToken();">Войти через Google</a></li>
          <li id="_revokeToken" style="display: none;"><a class="dropdown-item" href="#" onclick="revokeToken();">Выйти</a></li>
        </ul>
      </div>
    </div>
  </div>
</header>

<div class="col-lg-8 mx-auto p-4 py-md-5">
  <main>

    <h1>Авторизация через GSI и GAPI</h1>

    <button onclick="listMajors();">Запрос через Sheets API</button> <br><br>

    <button onclick="loadCalendar();">Загрузить Календарь</button><br><br>

  </main>
  <footer class="pt-5 my-5 text-muted border-top">
    Создано командой Жим "Прогрессивный" &middot; &copy; 2022
  </footer>
</div>

<!-- Профиль -->
<div class="modal" id="modProfile">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">

      <!-- Заголовок модального окна -->
      <div class="modal-header">
        <h4 class="modal-title">Профиль</h4>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- Тело модального окна -->
      <div class="modal-body">
        Тело профиля..
      </div>

      <!-- Подвал модального окна -->
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Закрыть</button>
      </div>

    </div>
  </div>
</div>

<!-- Настройки -->
<div class="modal" id="modSettings">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">

      <!-- Заголовок модального окна -->
      <div class="modal-header">
        <h4 class="modal-title">Настройки</h4>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- Тело модального окна -->
      <div class="modal-body">
        Тело настроек..
      </div>

      <!-- Подвал модального окна -->
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Закрыть</button>
      </div>

    </div>
  </div>
</div>

<script>
  let tokenClient;
  let access_token;
  let expires_in;

  if (window.localStorage.getItem("access_token"))
    access_token = localStorage.getItem("access_token");

  if (window.localStorage.getItem("token_expires_in"))
    expires_in = new Date(localStorage.getItem("token_expires_in")).getTime(); // время действия токена в милисекундах
  
  let gapiInited = false;
  let gisInited = false;

  async function gapiStart() {
    await gapi.client.init({
      }).then(function() {
        
        // Инициализация библиотеки Google API с полученным ключом
        if (access_token) {
          gapi.auth.setToken({access_token: access_token});
          gisInited = true;

        } 

        let now = new Date().getTime(); // текущее время в милисекундах
        
        if (now > expires_in) gisInited = false;
        
        gapi.client.load('drive', 'v3');
        gapi.client.load('sheets', 'v4');
        gapi.client.load('calendar','v3');

        console.info('Библиотека Client Google API инциализирована');
        
        gapiInited = true;
        //console.log(tokenClient);
        checkBeforeStart();
    }).then(function(response) {
      console.info('Библиотеки загружены');
    }, function(reason) {
      console.error('Ошибка: ' + reason.result.error.message);
    }).then(function() {
      //  console.log("access_token: ");
      //  console.log(access_token);
    });
  }

  function gapiLoad() {
    // обрабатываем загрузку библиотеки gapi
    gapi.load('client', gapiStart)
  }

  function gisInit() {
    // обрабатываем загрузку библиотеки gis
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: SCOPES,
      expires_in: 60*60*4-1,
      prompt: '',
      callback: (tokenResponse) => {
        let milliseconds = new Date().getTime() + (1 * Number(tokenResponse.expires_in) * 1000);
        let later = new Date(milliseconds);
        localStorage.setItem("token_expires_in", later);
        expires_in = later;
        console.warn("Токен истекает через " + tokenResponse.expires_in + " милисекунд");
        localStorage.setItem("access_token", tokenResponse.access_token);
        access_token = tokenResponse.access_token;

        console.info('Библиотека GIS инициализирована');
        gisInited = true;

        checkBeforeStart();
      },
    });
  }

  /*
   * Элементы управления
   */

  let btnGetToken = document.getElementById("_getToken");
  let btnRevokeToken = document.getElementById("_revokeToken");
  let imgAvatar = document.getElementById("_imgAvatar");
  let itemStart = document.getElementById("itemStart")
  let itemSettings = document.getElementById("itemSettings")
  let itemProfile = document.getElementById("itemProfile")

  let profile = document.getElementById('modProfile');
  let settings = document.getElementById('modSettings');
  let modProfile = new bootstrap.Modal(profile, {});
  let modSettings = new bootstrap.Modal(settings, {});
  
  function checkBeforeStart() {

    itemStart.onclick=function(){
      console.log('тренировка');
    }

    itemSettings.onclick=function(){
      console.log('настройки');
      modSettings.show();
    }

    itemProfile.onclick=function(){
      console.log('профиль');
      modProfile.show();
    }

    settings.addEventListener('shown.bs.modal', function () {
      console.warn("Окно 'Настройки' открыто");
    
    })

    //var myInput = document.getElementById('myInput')

    profile.addEventListener('shown.bs.modal', function () {
      console.warn("Окно 'Профиль' открыто");
      //myInput.focus()
    })

    console.info(`Проверка элементов управления. Параметры gapi: ${gapiInited}, gis: ${gisInited}.`);

    if (gapiInited && gisInited){

      USER = getUserProfileData(access_token);
      
      itemStart.classList.remove("disabled");
      itemSettings.classList.remove("disabled");
      itemProfile.classList.remove("disabled");
      
      btnGetToken.style.display="none";
      btnRevokeToken.style.display="block";
      
    } else {
      itemStart.classList.add("disabled");
      itemSettings.classList.add("disabled");
      itemProfile.classList.add("disabled");
      
      btnGetToken.style.display="block";
      btnRevokeToken.style.display="none";
      
      imgAvatar.src="https://via.placeholder.com/32/343a40/FFFFFF/?text=Ё";
      
    }
  
    console.info("Проверка авторизации выполнена")

  }

  function getToken() {
      // получить токен
      tokenClient.requestAccessToken();
  }

  function listMajors() {
      // получить данные из диапазона таблицы
      // используется идентификатор определенной таблицы
      gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: '1q_6BY4I83K2Ppdxrp9mTFlHJg5GXvle7Xn4Kr6ORmeE',
          range: 'Class Data!A1:E1',
      }).then(function(response) {
          let range = response.result;
          console.log(range);
      });
  }

  function loadCalendar() {
    if (access_token) {
      let xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://www.googleapis.com/calendar/v3/calendars/primary/events');
      xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
      xhr.send();
      
      gapi.client.calendar.events.list({ 'calendarId': 'primary' })
      .then(calendarAPIResponse => console.log(JSON.stringify(calendarAPIResponse)))
      .catch(err => console.log(err));
      /*
      document.getElementById("showEventsBtn").innerText = "Refresh Calendar";
      */
    }

    // Старая версия
    // этот алгоритм можно использовать если истек токен
    /*
    tokenClient.callback = (resp) => {
      if (resp.error !== undefined) {
        throw(resp);
      }
      // GIS has automatically updated gapi.client with the newly issued access token.
      console.log('gapi.client access token: ' + JSON.stringify(gapi.client.getToken()));
      let xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://www.googleapis.com/calendar/v3/calendars/primary/events');
      xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
      xhr.send();
    }

    // Conditionally ask users to select the Google Account they'd like to use,
    // and explicitly obtain their consent to fetch their Calendar.
    // NOTE: To request an access token a user gesture is necessary.

    if (gapi.client.getToken() === null) {
      // Prompt the user to select an Google Account and asked for consent to share their data
      // when establishing a new session.
      console.log("consent")

      tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
      // Skip display of account chooser and consent dialog for an existing session.
      console.log("_______")
      tokenClient.requestAccessToken({prompt: ''});
    }
*/

      
  }


  function revokeToken() {
    // отозвать токен

    let cred = gapi.client.getToken();

    if (cred !== null) {
      google.accounts.oauth2.revoke(cred.access_token, () => {
        console.warn('Токен отозван: ' + cred.access_token);
        
        gapi.client.setToken('');
        access_token = null;
        localStorage.setItem("access_token","");
        
        gisInited = false;
        
        checkBeforeStart();
      });
      
    }

  }

  // +%+%+%+%+%+%+%+%+%+%+%+%+%+%+%+%+%+%+%+%+%+%+% 
  // асинхронная функция для запроса данных профиля
  //
  const getUserProfileData = async (accessToken) => {
    let data;
      try {
        
        const headers = new Headers();
        
        headers.append('Authorization', `Bearer ${accessToken}`)
        const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
          headers
        })
        data = await response.json();
        console.info("Загружены данные пользователя");
        //console.log(data);

        // обрабатываем полученные данные
        let imgAvatar = document.getElementById("_imgAvatar");

        imgAvatar.src = data.picture;

      } catch(err) {
        console.error("Error:" + err); // TypeError: failed to fetch

      }

      
      return data;
  }

  //миграция в gis
  //https://developers.google.com/identity/oauth2/web/guides/migration-to-gis?hl=en#gapi-callback
  //https://developers.google.com/identity/gsi/web/reference/js-reference?hl=en&authuser=19

  //https://advancedweb.hu/using-google-auth-in-javascript/
  //https://github.com/sashee/drive-api-from-js
  //https://sashee.github.io/drive-api-from-js/
</script>

<script src="https://accounts.google.com/gsi/client" onload="gisInit()" async defer></script>
<script src="https://apis.google.com/js/api.js" onload="gapiLoad()" async defer></script>
    
</body>
</html>
