<!doctype html>
<html lang='ru'>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <meta name="description" content=''>
    <meta name='author' content='Alexey Kuznetsov'>

    <title>Жим "Прогрессивный"</title>
    
    <link href='css/template.css' rel='stylesheet'>

    <script src='js/gapi.js' async defer></script>
    <script src='js/config.js'></script>

    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css' rel='stylesheet' integrity='sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT' crossorigin='anonymous'>
    <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js' integrity='sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8' crossorigin='anonymous'></script>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js' integrity='sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ==' crossorigin='anonymous' referrerpolicy='no-referrer'></script>
    <style>
      /* https://www.codeply.com/p/4sL9uhevwJ */
      .form-check-input:checked {
        background-color: #dc3545;
        border-color: pink;
      }

      .form-switch .form-check-input {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='pink'/%3e%3c/svg%3e");
      }
      .form-switch .form-check-input:focus {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='pink'/%3e%3c/svg%3e");
      }

    </style>
  </head>
<body>

<header class='p-3 mb-3 border-bottom'>
  <div class='container'>
    <div class='d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start'>
      <a class='navbar-brand' href='javascript:void(0)'>
        <a href='#' class='d-flex align-items-center text-dark text-decoration-none'>
          <svg xmlns='http://www.w3.org/2000/svg' width='40' height='32' fill='currentColor' class='bi bi-bar-chart-fill' viewBox='0 0 16 16'>
            <title>Жим "Прогрессивный"</title>
            <path d='M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2z'/>
          </svg>
          <span class='fs-4'>Жим "Прогрессивный"</span>
        </a>
      </a>

      <ul class='nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0'>
        <li><a href='#' class='nav-link px-2 link-secondary'>О сайте</a></li>
        <li><a href='#' class='nav-link px-2 link-dark'>Контакты</a></li>
      </ul>

      <div class='dropdown text-end'>
        <a href='#' class='d-block link-dark text-decoration-none dropdown-toggle' data-bs-toggle='dropdown' aria-expanded='false'>
          <img id='_imgAvatar' src='placeholder.png' class='rounded-circle' width='32' height='32'></img> 
        </a>
        <ul class='dropdown-menu dropdown-menu-dark text-small'>
          <li><a id='itemStart' class='dropdown-item' href='#'>Начать тренировку...</a></li>
          <li><a id='itemSettings' class='dropdown-item' href='#'>Настройки</a></li>
          <li><a id='itemProfile' class='dropdown-item' href='#'>Профиль</a></li>
          <li><hr class='dropdown-divider'></li>
          <li id='_getToken'><a class='dropdown-item' href='#' onclick='getToken();'>Войти через Google</a></li>
          <li id='_revokeToken' style='display: none;'><a class='dropdown-item' href='#' onclick='revokeToken();'>Выйти</a></li>
        </ul>
      </div>
    </div>
  </div>
</header>

<div class='col-lg-8 mx-auto p-4 py-md-5'>
  <main>

    <h1>Авторизация через GSI и GAPI</h1>

    <button onclick='listMajors();'>Запрос через Sheets API</button> <br><br>

    <button onclick='loadCalendar();'>Загрузить Календарь</button><br><br>
<!--
    <button onclick="createConfigFile();">Создать файл конфигурации</button><br><br>

    <button onclick="getConfigFileId();">Получить идентификатор файла конфигурации</button><br><br>

    <button onclick="saveConfigFile();">Сохранить файл конфигурации</button><br><br>
-->
    <button onclick='loadConfigFile();'>Загрузить файл конфигурации</button><br><br>
<!--
    <button onclick="deleteConfigFile();">Удалить файл конфигурации</button><br><br>
-->
    <button onclick='listFiles();'>Список файлов</button><br><br>

  </main>
  <footer class='pt-5 my-5 text-muted border-top'>
    Создано командой Жим "Прогрессивный" &middot; &copy; 2022
  </footer>
</div>

<!-- Профиль -->
<div class='modal' id='modProfile'>
  <div class='modal-dialog'>
    <div class='modal-content bg-dark text-light'>

      <!-- Заголовок модального окна -->
      <div class='modal-header'>
        <h4 class='modal-title'>Профиль</h4>
        <button type='button' class='btn-close btn-close-white' data-bs-dismiss='modal'></button>
      </div>

      <!-- Тело модального окна -->
      <div class='modal-body bg-light text-dark'>
        <h3 class="mt-2 mb-0">Учётная запись Google</h3>
        <div class="card p-3 py-4">
          <div class="text-center">
              <img id='profile_avatar' src="" width="100" class="rounded-circle">
          </div>
          <div class="text-center mt-3">
              <!--<span class="bg-secondary p-1 px-4 rounded text-white">Pro</span>-->
              <h5 id='profile_name' class="mt-2 mb-0">...</h5>
              <span> </span>
              <div class="px-4 mt-1">
                  <br><p id='profile_email' class="fonts">...</p>
              </div>
              <!--<ul class="social-list">
                  <li><i class="fa fa-facebook"></i></li>
                  <li><i class="fa fa-dribbble"></i></li>
                  <li><i class="fa fa-instagram"></i></li>
                  <li><i class="fa fa-linkedin"></i></li>
                  <li><i class="fa fa-google"></i></li>
              </ul>
              <div class="buttons">
                  <button class="btn btn-outline-primary px-4">Message</button>
                  <button class="btn btn-primary px-4 ms-3">Contact</button>
              </div>-->
          </div>
        </div>
      </div>

      <!-- Подвал модального окна -->
      <div class='modal-footer'>
        <button type='button' class='btn btn-danger' data-bs-dismiss='modal'>Закрыть</button>
      </div>

    </div>
  </div>
</div>

<!-- Настройки -->
<div class="modal" id="modSettings">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">

      <!-- Заголовок модального окна -->
      <div class="modal-header">
        <h4 class="modal-title">Настройки</h4>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- Тело модального окна -->
      <div class="modal-body bg-light text-dark">

        <!-- Nav tabs -->
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a class="nav-link text-dark active" data-bs-toggle="tab" href="#home">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" data-bs-toggle="tab" href="#menu1">Menu 1</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-dark" data-bs-toggle="tab" href="#menu2">Menu 2</a>
          </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
          <div class="tab-pane container active" id="home">
            <h5 class="mb-0 mt-5">Notifications Settings</h5>
            <p>Select notification you want to receive</p>
            <hr class="my-4" />
            <strong class="mb-0">Security</strong>
            <p>Control security alert you will be notified.</p>
            <div class="list-group mb-5 shadow">
              <div class="list-group-item">
                <div class="row align-items-center">
                  <div class="col">
                    <strong class="mb-0">Unusual activity notifications</strong>
                    <p class="text-muted mb-0">Donec in quam sed urna bibendum tincidunt quis mollis mauris.</p>
                  </div>
                  <div class="col-auto">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="check1" checked>
                      <label class="form-check-label" for="check1"></label>
                    </div>
                  </div>
                </div>
              </div>
              <div class="list-group-item">
                <div class="row align-items-center">
                  <div class="col">
                    <strong class="mb-0">Unauthorized financial activity</strong>
                    <p class="text-muted mb-0">Fusce lacinia elementum eros, sed vulputate urna eleifend nec.</p>
                  </div>
                  <div class="col-auto">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="check2">
                      <label class="form-check-label" for="check2"></label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <hr class="my-4" />
            <strong class="mb-0">System</strong>
            <p>Please enable system alert you will get.</p>
            <div class="list-group mb-5 shadow">
              <div class="list-group-item">
                  <div class="row align-items-center">
                      <div class="col">
                          <strong class="mb-0">Notify me about new features and updates</strong>
                          <p class="text-muted mb-0">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
                      </div>
                      <div class="col-auto">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="check3" checked>
                          <label class="form-check-label" for="check3"></label>
                        </div>
                      </div>
                  </div>
              </div>
              <div class="list-group-item">
                  <div class="row align-items-center">
                      <div class="col">
                          <strong class="mb-0">Notify me by email for latest news</strong>
                          <p class="text-muted mb-0">Nulla et tincidunt sapien. Sed eleifend volutpat elementum.</p>
                      </div>
                      <div class="col-auto">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="check4" checked>
                          <label class="form-check-label" for="check4"></label>
                        </div>
                      </div>
                  </div>
              </div>
              <div class="list-group-item">
                  <div class="row align-items-center">
                      <div class="col">
                          <strong class="mb-0">Notify me about tips on using account</strong>
                          <p class="text-muted mb-0">Donec in quam sed urna bibendum tincidunt quis mollis mauris.</p>
                      </div>
                      <div class="col-auto">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="check5">
                          <label class="form-check-label" for="check5"></label>
                        </div>
                      </div>
                  </div>
              </div>
            </div>
          </div>
          <div class="tab-pane container fade" id="menu1">
            <p>2</p>
          </div>
          <div class="tab-pane container fade" id="menu2">
            <p>3</p>
          </div>
        </div>

<!--
        <div class="row justify-content-center">
          <div class="col-12 col-lg-10 col-xl-8 mx-auto">
              <h2 class="h3 mb-4 page-title">Settings</h2>
              <div class="my-4">
                  <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                      <li class="nav-item">
                          <a class="nav-link active" id="contact-tab" data-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="false">Notifications</a>
                      </li>
                  </ul>
                  <h5 class="mb-0 mt-5">Notifications Settings</h5>
                  <p>Select notification you want to receive</p>
                  <hr class="my-4" />
                  <strong class="mb-0">Security</strong>
                  <p>Control security alert you will be notified.</p>
                  <div class="list-group mb-5 shadow">
                      <div class="list-group-item">
                          <div class="row align-items-center">
                              <div class="col">
                                  <strong class="mb-0">Unusual activity notifications</strong>
                                  <p class="text-muted mb-0">Donec in quam sed urna bibendum tincidunt quis mollis mauris.</p>
                              </div>
                              <div class="col-auto">
                                  <div class="custom-control custom-switch">
                                      <input type="checkbox" class="custom-control-input" id="alert1" checked="" />
                                      <span class="custom-control-label"></span>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <div class="list-group-item">
                          <div class="row align-items-center">
                              <div class="col">
                                  <strong class="mb-0">Unauthorized financial activity</strong>
                                  <p class="text-muted mb-0">Fusce lacinia elementum eros, sed vulputate urna eleifend nec.</p>
                              </div>
                              <div class="col-auto">
                                  <div class="custom-control custom-switch">
                                      <input type="checkbox" class="custom-control-input" id="alert2" />
                                      <span class="custom-control-label"></span>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
                  <hr class="my-4" />
                  <strong class="mb-0">System</strong>
                  <p>Please enable system alert you will get.</p>
                  <div class="list-group mb-5 shadow">
                      <div class="list-group-item">
                          <div class="row align-items-center">
                              <div class="col">
                                  <strong class="mb-0">Notify me about new features and updates</strong>
                                  <p class="text-muted mb-0">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
                              </div>
                              <div class="col-auto">
                                  <div class="custom-control custom-switch">
                                      <input type="checkbox" class="custom-control-input" id="alert3" checked="" />
                                      <span class="custom-control-label"></span>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <div class="list-group-item">
                          <div class="row align-items-center">
                              <div class="col">
                                  <strong class="mb-0">Notify me by email for latest news</strong>
                                  <p class="text-muted mb-0">Nulla et tincidunt sapien. Sed eleifend volutpat elementum.</p>
                              </div>
                              <div class="col-auto">
                                  <div class="custom-control custom-switch">
                                      <input type="checkbox" class="custom-control-input" id="alert4" checked="" />
                                      <span class="custom-control-label"></span>
                                  </div>
                              </div>
                          </div>
                      </div>
                      <div class="list-group-item">
                          <div class="row align-items-center">
                              <div class="col">
                                  <strong class="mb-0">Notify me about tips on using account</strong>
                                  <p class="text-muted mb-0">Donec in quam sed urna bibendum tincidunt quis mollis mauris.</p>
                              </div>
                              <div class="col-auto">
                                  <div class="custom-control custom-switch">
                                      <input type="checkbox" class="custom-control-input" id="alert5" />
                                      <span class="custom-control-label"></span>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      
      
      </div>
-->
      </div>

      <!-- Подвал модального окна -->
      <div class="modal-footer bg-dark">
        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Закрыть</button>
      </div>

    </div>
  </div>
</div>

<script>
  let tokenClient;
  let access_token;
  let expires_in;
  
  if (window.localStorage.getItem('access_token'))
    access_token = localStorage.getItem('access_token');

  if (window.localStorage.getItem('token_expires_in'))
    expires_in = new Date(localStorage.getItem('token_expires_in')).getTime(); // время действия токена в милисекундах
  
  let gapiInited = false;
  let gisInited = false;

  function isLoggedIn() {
    const not_expired = (new Date().getTime()) < expires_in;
    return gapiInited && gisInited && not_expired;
  }

  function isExpired() {
    return (new Date().getTime()) > expires_in;
  }


  async function gapiStart() {
    Logo();
    await gapi.client.init({
      }).then(function() {
        
        // Инициализация библиотеки Google API с полученным ключом
        if (access_token) {
          //log (access_token,'Red','LemonChiffon');
          gapi.auth.setToken({access_token: access_token});
          gisInited = true;
        } 

        
        let now = new Date().getTime(); // текущее время в милисекундах
        
        TokenExpires(now,expires_in);

        if (now > expires_in) {
          gisInited = false;
        }
        
        gapi.client.load('drive', 'v3');
        gapi.client.load('sheets', 'v4');
        gapi.client.load('calendar','v3');

        //console.info('Библиотека Client Google API инциализирована');
        log('Библиотека Client Google API инциализирована','info');
        
        gapiInited = true;

        checkApp();

    }).then(function(response) {
        log('Библиотеки загружены','info');
    }, function(reason) {
      console.error('Ошибка: ' + reason.result.error.message);
    }).then(function() {
      //  log("access_token: ");
      //  log(access_token);
    });
  }

  function gapiLoad() {
    // обрабатываем загрузку библиотеки gapi
    gapi.load('client', gapiStart)
  }

  function gisInit() {
    // обрабатываем загрузку библиотеки gis
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: SCOPES,
      prompt: '',
      callback: (tokenResponse) => {
        let later = new Date(new Date().getTime() + (1 * Number(tokenResponse.expires_in) * 1000));

        localStorage.setItem('token_expires_in', later);
        expires_in = later;
 
        log('Токен истекает через ' + tokenResponse.expires_in + ' секунд','warning');
        
        localStorage.setItem('access_token', tokenResponse.access_token);
        access_token = tokenResponse.access_token;

        log('Библиотека GIS инициализирована','info');
        gisInited = true;

        checkApp();
      },
    });
  }

  /*
   * Элементы управления
   */

  let btnGetToken = document.getElementById('_getToken');
  let btnRevokeToken = document.getElementById('_revokeToken');
  let imgAvatar = document.getElementById('_imgAvatar');
  let itemStart = document.getElementById('itemStart')
  let itemSettings = document.getElementById('itemSettings')
  let itemProfile = document.getElementById('itemProfile')

  let profile = document.getElementById('modProfile');
  let settings = document.getElementById('modSettings');
  let modProfile = new bootstrap.Modal(profile, {});
  let modSettings = new bootstrap.Modal(settings, {});

  function checkApp() {
  
    itemStart.onclick=function(){
      log('тренировка');
    }

    itemSettings.onclick=function(){
      log('настройки');
      modSettings.show();
    }

    itemProfile.onclick=function(){
      log('профиль');
      modProfile.show();
    }

    settings.addEventListener('shown.bs.modal', function () {
      console.warn("Окно 'Настройки' открыто");
    
    })

    //var myInput = document.getElementById('myInput')

    profile.addEventListener('shown.bs.modal', function () {
      console.warn("Окно 'Профиль' открыто");
      //myInput.focus()
    })

    log(` Проверка элементов управления.\ 
 Параметры
 -------------------- 
 gapi:         ${gapiInited}
 gis:          ${gisInited}
 not expired:  ${!isExpired()}`,'MidnightBlue');

    if (gapiInited && gisInited && !isExpired()){
      log ('Активация элементов управления','info');
      //log(access_token,'White','Tomato');
      
      USER = getUserProfileData(access_token);

      itemStart.classList.remove('disabled');
      itemSettings.classList.remove('disabled');
      itemProfile.classList.remove('disabled');
      
      btnGetToken.style.display='none';
      btnRevokeToken.style.display='block';

      scheduleConfigSync();
    } else {
      log ('Дезактивация элементов управления','info');
      itemStart.classList.add('disabled');
      itemSettings.classList.add('disabled');
      itemProfile.classList.add('disabled');
      
      btnGetToken.style.display='block';
      btnRevokeToken.style.display='none';
      
      imgAvatar.src='placeholder.png';
      
    }
  
    log('Проверка авторизации выполнена','info');

  }

  function getToken() {
      // получить токен
      tokenClient.requestAccessToken();
  }

  function listMajors() {
      // получить данные из диапазона таблицы
      // используется идентификатор определенной таблицы
      gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: '1q_6BY4I83K2Ppdxrp9mTFlHJg5GXvle7Xn4Kr6ORmeE',
          range: 'Class Data!A1:E1',
      }).then(function(response) {
          let range = response.result;
          log(range);
      });
  }

  function loadCalendar() {
    if (access_token) {
      let xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://www.googleapis.com/calendar/v3/calendars/primary/events');
      xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
      xhr.send();
      
      gapi.client.calendar.events.list({ 'calendarId': 'primary' })
      .then(calendarAPIResponse => log(JSON.stringify(calendarAPIResponse)))
      .catch(err => log(err));
      /*
      document.getElementById("showEventsBtn").innerText = "Refresh Calendar";
      */
    }
      
  }


  function revokeToken() {
    // отозвать токен

    let cred = gapi.client.getToken();

    if (cred !== null) {
      deleteConfigFile();
      google.accounts.oauth2.revoke(cred.access_token, () => {
        console.warn('Токен отозван: ' + cred.access_token);
        
        gapi.client.setToken('');
        access_token = null;
        localStorage.setItem('access_token','');
        
        gisInited = false;
        
        checkApp();
      });
    }

  }

  /**
   * Запрос данных профиля
   */ 
  async function getUserProfileData (accessToken) {
    let data;
    
    try {
      
      const headers = new Headers();
      
      headers.append('Authorization', `Bearer ${accessToken}`)
      const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
        headers
      })
      data = await response.json();
      log(data);
      log('Данные пользователя загружены','info');
      
      // обрабатываем полученные данные
      let imgAvatar = document.getElementById('_imgAvatar');
      let profileAvatar = document.getElementById('profile_avatar');
      let profileName = document.getElementById('profile_name');
      let profileEmail = document.getElementById('profile_email');
      //log(profileName);
      profileAvatar.src = imgAvatar.src = data.picture;
      profileName.innerText = data.name;
      profileEmail.innerText = data.email;

    } catch(err) {
      log("Ошибка:" + err,'error');
      imgAvatar.src='placeholder.png';
      gisInited = false;
      checkApp();
    }

    return data;

  }

  /**
   * Получение идентификатора файла данных
   */ 
  async function getAppDataFileId(fileName) {
    return await gapi.client.drive.files.list({
      q: 'name="' + fileName + '"',
      spaces: 'appDataFolder',
      fields: 'files(id)',
      pageSize: 100,
      orderBy: 'createdTime'
    }).then(
      function (data) {
        if (_.isEmpty(data.result.files)) {
          throw 'Файлы не найдены';
        }
        return data.result.files[0].id;
      }
    );
  };

  /**
   * Поиск файлов
   */ 
  async function findFile(query) {
    return await prom(gapi.client.drive.files.list, {
      // вместо 'appDataFolder' можно использовать ID папки
      spaces: 'appDataFolder',
      fields: 'files(id,name)',
      pageSize: 100,
      orderBy: 'createdTime',
      q: 'name="' + query + '"'
    }).then(
      function (data) {
        if (_.isEmpty(data.result.files)) {
          throw 'Файлы не найдены';
        }
        // результат: массив объектов вида [{id: '...', name: '...'}], 
        // отсортированных по времени создания
        return data.result.files;
      }
    );
  };

  /**
   * Сохранение файла данных на Google диске
   */ 
  async function uploadFile(fileId, content) {
    log('Сохранено содержимое файла с идентификатором ' + fileId);
    // функция принимает либо строку, либо объект, который можно сериализовать в JSON
    return prom(gapi.client.request, {
      path: `/upload/drive/v3/files/${fileId}`,
      method: 'PATCH',
      params: {uploadType: 'media'},
      body: typeof content === 'string' ? content : JSON.stringify(content)
    })
  }

  /**
   * Скачивание файла данных с Google диска
   */
  async function downloadFile(fileId) {
    const resp = await prom(gapi.client.drive.files.get, {
      fileId: fileId,
      alt: 'media'
    });
    // resp.body хранит ответ в виде строки
    // resp.result — это попытка интерпретировать resp.body как JSON.
    // Если она провалилась, значение resp.result будет false
    // Т.о. функция возвращает либо объект, либо строку
    log('Загружен файл с идентификатором ' + fileId);

    return resp.result || resp.body;
  }

  function createConfigFile() {
    createEmptyFile(configFileName);
  }

  function saveConfigFile() {
    getConfigFileId().then(
      function(response) {
        configFileId = response;
        log('Сохранение конфигурации в файл с идентификатором ' + configFileId);
        
        uploadFile(configFileId, DEFAULT_CONFIG);
      }
    );
  }

  function loadConfigFile() {
    getConfigFileId().then(
      function(response) {
        configFileId = response;
        log('Загрузка файла конфигурации с идентификатором ' + configFileId);
        
        downloadFile(configFileId).then(
          function(appData){
            log(appData);
        });   
      }
    );

  }

  async function deleteConfigFile() {
    configFileId = await getConfigFileId();
    deleteFile(configFileId).then(
      function(info){
        localStorage.removeItem(app_name + '_configFileId');
          if (info) log('Файл конфигурации удалён','warning');
    });
  }

  async function getConfigFileId() {

      // берем configFileId
      let configFileId = localStorage.getItem(app_name + '_configFileId');
      if (!configFileId) {
          // ищем нужный файл на Google Drive
          const configFiles = await find('name = "' + configFileName + '"');
          if (configFiles.length > 0) {
              // берем первый (раньше всех созданный) файл
              configFileId = configFiles[0].id;
          } else {
              // создаем новый
              configFileId = await createEmptyFile(configFileName);
          }
          // сохраняем ID
          localStorage.setItem(app_name + '_configFileId', configFileId);
      }

      return configFileId;

  }

  /**
  * Вывод метаданных для первых 10 файлов.
  */
  async function listFiles() {
    let response;
    try {
      response = await gapi.client.drive.files.list({
        'pageSize': 10,
        'fields': 'files(id, name)',
      });
    } catch (err) {
      log(err.message);
      return;
    }
    const files = response.result.files;
    if (!files || files.length == 0) {
      log('Файлы не найдены.');
      return;
    }
    // Подготовка строки вывода
    const output = files.reduce(
        (str, file) => `${str}${file.name} (${file.id}\n`,
        'Файлы:\n');
    log(output);
  }

  async function syncConfig() {
    if (!isLoggedIn) {
        return;
    }
    // получаем config file ID
    const configFileId = await getConfigFileId();
    try {
      // загружаем конфиг
      const remoteConfig = await downloadFile(configFileId);
      if (!remoteConfig || typeof remoteConfig !== 'object') {
        // пустой или испорченный конфиг, перезаписываем текущим
        uploadFile(configFileId, getConfig());
      } else {
        // сохраняем локально, перезаписывая существующие данные
        localStorage.setItem(app_name + '_config', JSON.stringify(remoteConfig))
      }
      // синхронизация завершена, в localStorage актуальный конфиг
      log('Синхронизация завершена, в localStorage актуальный конфиг');
    } catch(e) {
      if (e.status === 404) {
        // кто-то удалил наш конфиг, забываем неверный fileID и пробуем еще раз
        localStorage.removeItem(app_name + '_configFileId');
        syncConfig();
      } else {
        throw e;
      }
    }
  }

  function scheduleConfigSync(delay) {
    log('Запущен таймер синхронизации конфига','info');
    // сбрасываем старый таймер, если он был
    if (configSyncTimeoutId) {
      clearTimeout(configSyncTimeoutId);
    }
    configSyncTimeoutId = setTimeout(() => {
      // выполняем синхронизацию и шедулим снова
      syncConfig()
        .catch(e => log('Ошибка синхронизации файла конфигурации', e))
        .finally(() => scheduleConfigSync());
    }, typeof delay === 'undefined' ? SYNC_PERIOD : delay);
  }

</script>

<script src='js/logger.js'></script>
<script src='https://accounts.google.com/gsi/client' onload='gisInit()' async defer></script>
<script src='https://apis.google.com/js/api.js' onload='gapiLoad()' async defer></script>
    
</body>
</html>
